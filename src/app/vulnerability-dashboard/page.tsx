"use client";

import React, { useState } from "react";
import { AlertTriangle, Server, Radio, ArrowRightLeft } from "lucide-react";
import StatusCard from "@/components/card/StatusCard";
import VulnerabilityChart from "@/components/VulnerabilityChart";
import SecurityTrendChart from "@/components/SecurityTrendChart";
import ActiveSecurityAlerts from "@/components/ActiveSecurityAlerts";
import PluginTable from "@/components/PluginTable";
import ServicesTable from "@/components/ServicesTable";
import SummaryStats from "@/components/SummaryStats";
import CriticalVulnerabilitiesPanel from "@/components/CriticalVulnerabilitiesPanel";
import HighVulnerabilitiesPanel from "@/components/HighVulnerabilitiesPanel";
import VulnerabilityModal from "@/components/VulnerabilityModal";
import { useScanBatch } from "@/hooks/useScanBatch";
import { Container, Flex, Grid, Heading } from "@radix-ui/themes";

const VulnerabilityDashboard = () => {
  const {
    criticalVulnerabilities,
    highVulnerabilities,
    mediumVulnerabilities,
    lowVulnerabilities,
    infoVulnerabilities,
    vulnerabilities,
    vulnerabilityPorts,
    severities,
    serviceNames,
    assets,
    plugins,
    osVersions,
    loading,
  } = useScanBatch("bdb85b25-6c55-4124-a47b-00ab41379b2f");

  // Modal state
  const [isInfoDialogOpen, setInfoDialogIsOpen] = useState<boolean>(false);
  const [selectedAssetDialog, setSelectedAssetDialog] = useState<string>("All");
  const [selectedSeverityDialog, setSelectedSeverityDialog] =
    useState<string>("");
  const [, setSelectSeverity] = useState<string>("");

  // Asset selectors
  const [selectedAssetPlugin, setSelectedAssetPlugin] = useState<string>("All");
  const [selectedAssetUser, setSelectedAssetUser] = useState<string>("All");
  const [
    selectedAssetActiveSecurityAlerts,
    setSelectedAssetActiveSecurityAlerts,
  ] = useState<string>("All");

  const handleOpenDialog = (entry: {
    name: string;
    color: string;
    value: number;
  }) => {
    setSelectedSeverityDialog(entry.name);
    setSelectedAssetDialog("All");
    setTimeout(() => {
      setSelectSeverity(entry.name);
      setInfoDialogIsOpen(true);
    }, 0);
  };

  const handleCloseDialog = () => {
    setInfoDialogIsOpen(false);
    setSelectedAssetDialog("All");
  };

  if (loading) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-50">
        <div className="text-xl">Loading...</div>
      </div>
    );
  }

  return (
    <Container size="4">
      <Flex direction="column" gap="4" className="mb-6">
        <Flex direction="column" gap="6">
          <Heading
            size="9"
            weight="bold"
          >
            Vulnerability Dashboard
          </Heading>

          {/* Summary Cards */}
          <Flex direction="row" gap="4" wrap="wrap">
            <StatusCard
              color="bg-red-500 text-white"
              data={criticalVulnerabilities.length}
              icon={<AlertTriangle className="mr-3 h-8 w-8" />}
              label="Critical Alerts"
            />
            <StatusCard
              color="bg-orange-400 text-white"
              data={highVulnerabilities.length}
              icon={<Server className="mr-3 h-8 w-8" />}
              label="High Alerts"
            />
            <StatusCard
              color="bg-blue-500 text-white"
              data={assets.length}
              icon={<Radio className="mr-3 h-8 w-8" />}
              label="Total Assets"
            />
            <StatusCard
              color="bg-green-500 text-white"
              data={plugins.length}
              icon={<ArrowRightLeft className="mr-3 h-8 w-8" />}
              label="Active Plugins"
            />
          </Flex>

          {/* Main Content Grid */}
          <Grid columns={{ initial: "1", lg: "3" }} gap="6">
            <VulnerabilityChart
              severity={severities}
              onOpenDialog={handleOpenDialog}
            />
            <CriticalVulnerabilitiesPanel
              scanVulnerabilities={criticalVulnerabilities}
            />
            <HighVulnerabilitiesPanel
              highVulnerabilities={highVulnerabilities}
            />
          </Grid>

          {/* Security Metrics Trend */}
          <SecurityTrendChart />

          {/* Active Security Alerts Table */}
          <ActiveSecurityAlerts
            assets={assets}
            selectedAssetName={selectedAssetActiveSecurityAlerts}
            setSelectedAssetName={setSelectedAssetActiveSecurityAlerts}
          />

          {/* Additional Tables */}
          <Grid columns={{ initial: "1", lg: "2" }} gap="6">
            <PluginTable
              assets={assets}
              plugins={plugins}
              selectedAssetName={selectedAssetPlugin}
              setSelectedAssetName={setSelectedAssetPlugin}
            />
            <ServicesTable
              assets={assets}
              serviceNames={serviceNames}
              selectedAssetName={selectedAssetUser}
              setSelectedAssetName={setSelectedAssetUser}
            />
          </Grid>

          {/* Summary Stats */}
          <SummaryStats
            vulnerabilityPorts={vulnerabilityPorts}
            pluginTypes={plugins}
            osVersion={osVersions}
            vulnerabilities={vulnerabilities}
            serviceNames={serviceNames}
            assets={assets}
          />
        </Flex>
      </Flex>

      {/* Modal Dialog */}
      <VulnerabilityModal
        isOpen={isInfoDialogOpen}
        onClose={handleCloseDialog}
        selectedSeverityDialog={selectedSeverityDialog}
        selectedAssetDialog={selectedAssetDialog}
        setSelectedAssetDialog={setSelectedAssetDialog}
        criticalVulnerabilities={criticalVulnerabilities}
        highVulnerabilities={highVulnerabilities}
        mediumVulnerabilities={mediumVulnerabilities}
        lowVulnerabilities={lowVulnerabilities}
        infoVulnerabilities={infoVulnerabilities}
        assets={assets}
      />
    </Container>
  );
};

export default VulnerabilityDashboard;
